# Define Feature Shepherd Contract Structure

## Description

Establish the standard `features/{FEATURE_KEY}/` folder structure and contracts for Feature Shepherd suites. Each shepherded feature requires a set of canonical files that serve as the authoritative source of truth for Playwright Agents (Planner, Generator, Healer) and human developers.

This task creates the directory structure, defines the contract format, and implements validation/helper utilities for working with feature contracts.

## Dependencies

- None (foundational task)

## Acceptance Criteria

- [ ] `features/` directory created at repo root
- [ ] `features/_templates/` directory with template files:
  - [ ] `prd.md.template` - Feature-specific PRD template
  - [ ] `acceptance.md.template` - Acceptance criteria template (Gherkin-style optional)
  - [ ] `data.md.template` - Test data and fixtures template
  - [ ] `risks.md.template` - Known risks and flakiness sources template
  - [ ] `shepherd.config.json.template` - Configuration template with entry URLs, roles, flags, code mapping
- [ ] Validation script `scripts/validate-shepherd-contract.ts` that checks:
  - [ ] Required files exist for a given feature key
  - [ ] `shepherd.config.json` has required fields (featureKey, entryUrl, requiredRole, codeOwners)
  - [ ] codeOwners has globs, routePrefixes, labels arrays
- [ ] Helper script `scripts/create-shepherd-feature.ts` to scaffold new feature contracts
- [ ] Documentation in `features/README.md` explaining the contract structure
- [ ] Example feature contract created under `features/example/` for reference

## Test Criteria

```gherkin
Feature: Feature Shepherd Contract Structure
  As a developer
  I want a standard feature folder for shepherds
  So that agents and humans share the same source of truth

  @REQ-FSH-001
  Scenario: Template files exist and are valid
    Given the features/_templates/ directory exists
    Then it should contain prd.md.template
    And it should contain acceptance.md.template
    And it should contain data.md.template
    And it should contain risks.md.template
    And it should contain shepherd.config.json.template

  @REQ-FSH-001
  Scenario: Create new feature contract with scaffolding script
    When I run "bun scripts/create-shepherd-feature.ts checkout"
    Then features/checkout/ directory should be created
    And features/checkout/prd.md should exist (from template)
    And features/checkout/acceptance.md should exist (from template)
    And features/checkout/data.md should exist (from template)
    And features/checkout/risks.md should exist (from template)
    And features/checkout/shepherd.config.json should exist with featureKey "checkout"

  @REQ-FSH-001
  Scenario: Validate complete feature contract
    Given features/checkout/ has all required files
    When I run "bun scripts/validate-shepherd-contract.ts checkout"
    Then the validation should pass
    And no errors should be reported

  @REQ-FSH-001
  Scenario: Detect missing contract files
    Given features/incomplete/ is missing data.md
    When I run "bun scripts/validate-shepherd-contract.ts incomplete"
    Then the validation should fail
    And an error should list the missing file: data.md

  @REQ-FSH-008
  Scenario: shepherd.config.json includes code mapping fields
    Given features/checkout/shepherd.config.json exists
    Then it should have field "codeOwners.globs" as an array
    And it should have field "codeOwners.routePrefixes" as an array
    And it should have field "codeOwners.labels" as an array
```

## Implementation

### 1. Directory Structure

Create the following structure:

```
features/
├── README.md                           # Documentation for contract system
├── _templates/                         # Templates for new features
│   ├── prd.md.template
│   ├── acceptance.md.template
│   ├── data.md.template
│   ├── risks.md.template
│   └── shepherd.config.json.template
└── example/                            # Reference implementation
    ├── prd.md
    ├── acceptance.md
    ├── data.md
    ├── risks.md
    ├── shepherd.config.json
    ├── plan.md                         # Generated by Planner (placeholder)
    └── report.md                       # Generated by Agents (placeholder)
```

### 2. Template: shepherd.config.json.template

```json
{
  "featureKey": "{FEATURE_KEY}",
  "entryUrl": "/{FEATURE_KEY}",
  "requiredRole": "user",
  "featureFlags": [],
  "codeOwners": {
    "globs": [
      "app/{FEATURE_KEY}/**",
      "src/components/{FEATURE_KEY}/**",
      "src/lib/{FEATURE_KEY}/**"
    ],
    "routePrefixes": ["/{FEATURE_KEY}"],
    "labels": ["feature:{FEATURE_KEY}", "shepherd:{FEATURE_KEY}"]
  },
  "goldenPath": "Navigate to {FEATURE_KEY}, verify core functionality works",
  "invariants": [
    "No console errors on page load",
    "All API calls return expected status codes",
    "UI renders without layout shift or flashing"
  ]
}
```

### 3. Template: prd.md.template

```markdown
# {FEATURE_NAME} - Feature PRD

**Feature Key**: {FEATURE_KEY}
**Version**: 1.0
**Status**: Planning

## Summary

Brief description of the feature and its purpose.

## User Stories

- As a [user type], I want [goal] so that [benefit]

## Requirements

### Functional Requirements

- REQ-{FEATURE_KEY}-001: [Description]
- REQ-{FEATURE_KEY}-002: [Description]

### Non-Functional Requirements

- Performance, security, accessibility, etc.

## Out of Scope

What this feature does NOT include.

## References

- Link to main product PRD
- Related features
```

### 4. Template: acceptance.md.template

```markdown
# {FEATURE_NAME} - Acceptance Criteria

## Feature Key: {FEATURE_KEY}

## Acceptance Scenarios

### Scenario 1: [Happy Path]

**Given** [precondition]
**When** [action]
**Then** [expected result]

### Scenario 2: [Edge Case]

**Given** [precondition]
**When** [action]
**Then** [expected result]

## Gherkin Format (Optional)

```gherkin
Feature: {FEATURE_NAME}
  As a [user]
  I want [goal]
  So that [benefit]

  @REQ-{FEATURE_KEY}-001
  Scenario: [Description]
    Given [precondition]
    When [action]
    Then [expected result]
```

## Invariants

- [Core business rule that must always hold]
- [Another invariant]
```

### 5. Template: data.md.template

```markdown
# {FEATURE_NAME} - Test Data

## Feature Key: {FEATURE_KEY}

## Test Users

| Role       | Email                        | Password        | Notes                  |
|------------|------------------------------|-----------------|------------------------|
| user       | test-user@example.com        | [from secrets]  | Standard user account  |
| admin      | test-admin@example.com       | [from secrets]  | Admin account          |

## Test Fixtures

### Valid Input Examples

```json
{
  "field1": "value1",
  "field2": "value2"
}
```

### Edge Cases

- Empty strings
- Maximum length values
- Special characters
- Invalid formats

## Database Seeds

- Describe any required database state
- Reference seed scripts if applicable

## External Service Mocks

- List any mocked API endpoints
- Expected responses
```

### 6. Template: risks.md.template

```markdown
# {FEATURE_NAME} - Test Risks

## Feature Key: {FEATURE_KEY}

## Known Risks

### Flakiness Sources

- **Race conditions**: [Description and mitigation]
- **Network dependencies**: [Description and mitigation]
- **Timing-dependent assertions**: [Description and mitigation]

### Brittle Locators

- **Dynamic IDs**: Avoid using generated IDs in selectors
- **Fragile CSS**: Prefer role/text/testid over class names

### External Dependencies

- **Third-party APIs**: [Which ones, how to mock/stub]
- **Feature flags**: [Required flags and fallback behavior]

## Mitigation Strategies

- Use explicit waits instead of sleep/delay
- Prefer stable locators (roles, test IDs)
- Isolate test data per run (unique emails, tenant isolation)
- Document timeouts and retry policies
```

### 7. Validation Script: scripts/validate-shepherd-contract.ts

```typescript
import { existsSync, readFileSync } from 'node:fs';
import { join } from 'node:path';

interface ShepherdConfig {
	featureKey: string;
	entryUrl: string;
	requiredRole: string;
	featureFlags?: string[];
	codeOwners: {
		globs: string[];
		routePrefixes: string[];
		labels: string[];
	};
	goldenPath?: string;
	invariants?: string[];
}

const REQUIRED_FILES = [
	'prd.md',
	'acceptance.md',
	'data.md',
	'risks.md',
	'shepherd.config.json',
];

function validateFeatureContract(featureKey: string): void {
	const featurePath = join(process.cwd(), 'features', featureKey);

	if (!existsSync(featurePath)) {
		console.error(`❌ Feature folder not found: features/${featureKey}/`);
		process.exit(1);
	}

	// Check required files
	const missingFiles: string[] = [];
	for (const file of REQUIRED_FILES) {
		const filePath = join(featurePath, file);
		if (!existsSync(filePath)) {
			missingFiles.push(file);
		}
	}

	if (missingFiles.length > 0) {
		console.error(`❌ Missing required files in features/${featureKey}/:`);
		for (const file of missingFiles) {
			console.error(`   - ${file}`);
		}
		process.exit(1);
	}

	// Validate shepherd.config.json structure
	const configPath = join(featurePath, 'shepherd.config.json');
	let config: ShepherdConfig;
	try {
		const configContent = readFileSync(configPath, 'utf-8');
		config = JSON.parse(configContent);
	} catch (error) {
		console.error(
			`❌ Invalid JSON in shepherd.config.json: ${error instanceof Error ? error.message : String(error)}`,
		);
		process.exit(1);
	}

	const errors: string[] = [];

	if (!config.featureKey) {
		errors.push('Missing required field: featureKey');
	} else if (config.featureKey !== featureKey) {
		errors.push(
			`featureKey mismatch: expected "${featureKey}", got "${config.featureKey}"`,
		);
	}

	if (!config.entryUrl) errors.push('Missing required field: entryUrl');
	if (!config.requiredRole) errors.push('Missing required field: requiredRole');

	if (!config.codeOwners) {
		errors.push('Missing required field: codeOwners');
	} else {
		if (!Array.isArray(config.codeOwners.globs)) {
			errors.push('codeOwners.globs must be an array');
		}
		if (!Array.isArray(config.codeOwners.routePrefixes)) {
			errors.push('codeOwners.routePrefixes must be an array');
		}
		if (!Array.isArray(config.codeOwners.labels)) {
			errors.push('codeOwners.labels must be an array');
		}
	}

	if (errors.length > 0) {
		console.error(`❌ Validation errors in shepherd.config.json:`);
		for (const error of errors) {
			console.error(`   - ${error}`);
		}
		process.exit(1);
	}

	console.log(`✅ Feature contract validation passed for "${featureKey}"`);
}

// CLI entry point
const featureKey = process.argv[2];
if (!featureKey) {
	console.error('Usage: bun scripts/validate-shepherd-contract.ts <featureKey>');
	process.exit(1);
}

validateFeatureContract(featureKey);
```

### 8. Scaffolding Script: scripts/create-shepherd-feature.ts

```typescript
import { mkdirSync, readFileSync, writeFileSync } from 'node:fs';
import { join } from 'node:path';

function createShepherdFeature(featureKey: string): void {
	const featurePath = join(process.cwd(), 'features', featureKey);
	const templatesPath = join(process.cwd(), 'features', '_templates');

	// Create feature directory
	mkdirSync(featurePath, { recursive: true });

	// Template files to copy
	const templates = [
		'prd.md.template',
		'acceptance.md.template',
		'data.md.template',
		'risks.md.template',
		'shepherd.config.json.template',
	];

	for (const template of templates) {
		const templatePath = join(templatesPath, template);
		const targetFile = template.replace('.template', '');
		const targetPath = join(featurePath, targetFile);

		let content = readFileSync(templatePath, 'utf-8');

		// Replace placeholders
		content = content.replace(/\{FEATURE_KEY\}/g, featureKey);
		content = content.replace(
			/\{FEATURE_NAME\}/g,
			featureKey.charAt(0).toUpperCase() + featureKey.slice(1),
		);

		writeFileSync(targetPath, content, 'utf-8');
	}

	// Create placeholder plan.md and report.md
	writeFileSync(
		join(featurePath, 'plan.md'),
		`# Test Plan for ${featureKey}\n\n_This file will be generated by the Planner agent._\n`,
	);
	writeFileSync(
		join(featurePath, 'report.md'),
		`# Shepherd Report for ${featureKey}\n\n_This file will be generated by Playwright Agents._\n`,
	);

	console.log(`✅ Created feature contract for "${featureKey}" at features/${featureKey}/`);
	console.log('   Next steps:');
	console.log(`   1. Edit features/${featureKey}/prd.md with feature requirements`);
	console.log(`   2. Edit features/${featureKey}/acceptance.md with acceptance criteria`);
	console.log(`   3. Edit features/${featureKey}/data.md with test data`);
	console.log(`   4. Edit features/${featureKey}/risks.md with known risks`);
	console.log(`   5. Validate: bun scripts/validate-shepherd-contract.ts ${featureKey}`);
}

// CLI entry point
const featureKey = process.argv[2];
if (!featureKey) {
	console.error('Usage: bun scripts/create-shepherd-feature.ts <featureKey>');
	process.exit(1);
}

createShepherdFeature(featureKey);
```

### 9. README.md

Create `features/README.md` documenting the contract system:

```markdown
# Feature Shepherd Contracts

This directory contains **Feature Shepherd contracts** - the authoritative source of truth for end-to-end testing of product features using Playwright Agents.

## Structure

Each feature gets a folder: `features/{FEATURE_KEY}/`

Required files:
- `prd.md` - Feature-specific PRD (scope, states, permissions)
- `acceptance.md` - Testable acceptance criteria (Gherkin-style optional)
- `data.md` - Test accounts, roles, fixtures, example inputs, edge cases
- `risks.md` - Known risks, flakiness sources, and what to avoid in tests
- `shepherd.config.json` - Configuration (entry URLs, roles, flags, code mapping)

Generated files (by Playwright Agents):
- `plan.md` - Test plan generated by Planner agent
- `report.md` - Coverage report generated by agents

## Creating a New Feature Contract

Use the scaffolding script:

```bash
bun scripts/create-shepherd-feature.ts <featureKey>
```

This creates the folder structure with template files.

## Validating a Feature Contract

```bash
bun scripts/validate-shepherd-contract.ts <featureKey>
```

Checks that all required files exist and `shepherd.config.json` is valid.

## Code Mapping (REQ-FSH-008)

The `codeOwners` field in `shepherd.config.json` maps code changes to shepherd suites for CI:

```json
{
  "codeOwners": {
    "globs": ["app/checkout/**", "src/components/checkout/**"],
    "routePrefixes": ["/checkout", "/cart"],
    "labels": ["feature:checkout", "shepherd:checkout"]
  }
}
```

CI runs a shepherd if:
- Changed files match any `globs` pattern, OR
- Changed files are under `features/{FEATURE_KEY}/`, OR
- PR has a label in `labels` array

## References

- `documentation/PRDs/feature-shepherds.md` - Full PRD for Feature Shepherds system
- `tasks/testing/feature-shepherd-contracts.md` - Task file for this implementation
```

## Files

### New Files Created

- `features/README.md` - Documentation for contract system
- `features/_templates/prd.md.template` - PRD template
- `features/_templates/acceptance.md.template` - Acceptance criteria template
- `features/_templates/data.md.template` - Test data template
- `features/_templates/risks.md.template` - Risks template
- `features/_templates/shepherd.config.json.template` - Config template
- `features/example/prd.md` - Example feature PRD
- `features/example/acceptance.md` - Example acceptance criteria
- `features/example/data.md` - Example test data
- `features/example/risks.md` - Example risks
- `features/example/shepherd.config.json` - Example config
- `features/example/plan.md` - Placeholder (will be generated)
- `features/example/report.md` - Placeholder (will be generated)
- `scripts/validate-shepherd-contract.ts` - Validation script
- `scripts/create-shepherd-feature.ts` - Scaffolding script

### Files Modified

None (this is a foundational task)

## Notes

- The `features/` directory is **documentation-first** - it defines what should be tested, not how
- Playwright Agents (Planner/Generator/Healer) read these contracts and generate tests in `e2e/shepherd/`
- Feature contracts are **version controlled** and reviewed like code
- Changes to acceptance criteria or PRD should trigger shepherd regeneration
- The example feature provides a reference implementation for developers

## References

- `documentation/PRDs/feature-shepherds.md` - Full PRD (REQ-FSH-001, REQ-FSH-008)
- `documentation/PRDs/workflow.md` - Testing and automation strategy
- Playwright Agents documentation - https://playwright.dev/docs/test-agents
