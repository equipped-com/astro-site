
# Feature Shepherds with Playwright Agents – PRD

**Version**: 1.0  
**Last Updated**: December 2025  
**Status**: Planning  
**Type**: Process Improvement  

---

## Executive Summary

This PRD defines a standardized **“Feature Shepherd”** system for end-to-end testing using **Playwright Test + Playwright Agents** (Planner → Generator → Healer) in the Equipped repo.

Each **product feature** gets:

- A **canonical feature contract** under `features/{FEATURE_KEY}/` (PRD, acceptance criteria, data, risks, config, plan, report).
- A **dedicated shepherd test suite** under `e2e/shepherd/{FEATURE_KEY}/` generated and maintained by Playwright Agents.
- **CI wiring** so only affected shepherds run on PRs, and the full shepherd suite runs on nightly/staging environments.

Repo-wide, we integrate Playwright Agents with the existing `e2e/` infrastructure and testing strategy defined in `documentation/PRDs/workflow.md` and `tasks/testing/*`, so agents can read authoritative documents, generate tests using shared fixtures, and keep tests healthy without masking regressions.

**Scope:**

- Repository-wide setup of Playwright Test + Playwright Agents.
- Shared E2E fixtures and helpers for agent-generated tests (`e2e/fixtures/**`).
- Standardized `features/{FEATURE_KEY}/` folder contracts (prd/acceptance/data/risks/config/plan/report).
- Shepherd prompt template in `features/_templates/shepherd.prompt.md`.
- Planner/Generator/Healer workflow that reads feature contracts and emits `e2e/shepherd/{FEATURE_KEY}/` tests and `report.md`.
- CI integration: change-based shepherd selection on PRs + nightly full run (ideally on staging).

**Out of Scope:**

- Replacing all existing Vitest or Playwright tests with shepherd suites.
- Building a UI dashboard for shepherd status (textual reports only in this PRD).
- General-purpose agent orchestration beyond Playwright Agents for E2E.
- Non-web test automation (e.g., CLIs, pure API load tests).

---

## Problem Statement

We are standardizing PRDs and task generation, and we have a Playwright E2E setup (`tasks/testing/setup-playwright.md`), but we **lack a structured, feature-centric E2E system** that:

- Treats each feature as a **contract** (requirements + acceptance + data + risks).
- Keeps E2E tests **aligned** with that contract as features evolve.
- Lets **agents** (and humans) safely extend and maintain E2E coverage.

Today:

- E2E tests are not consistently organized by **feature key**, making it harder to know “what covers what”.
- Adding or updating tests for a specific feature requires **manual test design** and wiring.
- There is **no standard prompt** or protocol for ML agents to generate Playwright tests using our PRDs, data, and fixtures.
- CI cannot easily map a change in `app/{feature}/**` or `features/{FEATURE_KEY}/**` to the relevant E2E tests.

We need a **repeatable pattern** where each feature gets a “shepherd” — a focused, automatically maintained E2E suite — wired into CI, using Playwright Agents and our existing testing and task systems.

**Target Personas:**

- **Engineers** implementing and refactoring product features.
- **QA/Release owners** verifying regressions before deployments.
- **ML agents** responsible for planning, generating, and healing Playwright tests.
- **Product owners** wanting clear coverage per feature.

**Current Pain Points:**

- No canonical, per-feature E2E definition of “what must always work”.
- Hard to see which E2E tests are impacted by a given PR.
- Agent-generated tests (future) have no consistent folder structure or prompts.
- Risk of “healed” tests silently drifting from feature requirements.

---

## Requirements

### REQ-FSH-001: Standard Feature Shepherd Contract Folders

Create a **canonical folder per shepherded feature**:

`features/{FEATURE_KEY}/`

Required files:

- `prd.md` – feature-specific PRD (scope, states, permissions; may reference main product PRDs).
- `acceptance.md` – structured, testable acceptance criteria (Gherkin-style allowed, but not required).
- `data.md` – test accounts, roles, fixtures, example inputs, edge cases.
- `risks.md` – known risks, flakiness sources, and what to avoid in tests.
- `shepherd.config.json` – config including:
  - Entry URLs and required roles
  - Feature flags needed for testing
  - **Code mapping** (`code_owners_globs`, `route_prefixes`, `labels`) for CI selection
  - Golden path outline and invariants
- `plan.md` – **generated by Planner** (test plan).
- `report.md` – **generated by Agents** (what changed, coverage, gaps).

````gherkin mode=EXCERPT
Feature: Feature shepherd contract
  As a developer
  I want a standard feature folder for shepherds
  So that agents and humans share the same source of truth

  @REQ-FSH-001
  Scenario: Checkout feature has shepherd contract files
    Given a feature key "checkout"
    Then the folder features/checkout contains prd.md, acceptance.md, data.md, risks.md, shepherd.config.json
````

---

### REQ-FSH-002: Playwright Agents Integration with Existing E2E Stack

Integrate **Playwright Agents** (Planner, Generator, Healer) into the existing **Playwright E2E setup** (`e2e/`, `playwright.config.ts`):

**Setup Requirements:**

1. **Initialize Playwright Agents** using the official CLI:
   ```bash
   npx playwright init-agents --loop=claude
   ```
   - This generates agent definitions in `.github/` directory
   - Review and regenerate agent definitions as needed (when major Playwright updates add new tools or instructions)

2. **Directory Structure Alignment:**
   ```
   repo/
     .github/                           # Agent definitions (generated by init-agents)
     features/{FEATURE_KEY}/            # Feature contracts (our convention)
       prd.md                           # Feature requirements
       acceptance.md                    # Acceptance criteria
       data.md                          # Test data and fixtures
       risks.md                         # Known risks and edge cases
       shepherd.config.json             # Entry URLs, roles, flags
       plan.md                          # Generated by Planner (Markdown test plan)
       report.md                        # Generated by Agents (coverage report)
     e2e/
       fixtures/                        # Shared helpers and auth fixtures
       shepherd/{FEATURE_KEY}/          # Generated tests for each feature
         seed.spec.ts                   # Bootstrap test (environment setup)
         *.spec.ts                      # Generated test files
     playwright.config.ts               # Existing Playwright configuration
   ```

3. **Agent Workflow:**
   - **Planner**: Reads `features/{FEATURE_KEY}/` contracts and produces `plan.md` (Markdown test specification)
   - **Generator**: Transforms `plan.md` into executable tests in `e2e/shepherd/{FEATURE_KEY}/`
   - **Healer**: Debugs failing tests by inspecting UI, updating locators, and retrying until tests pass

4. **Agent Configuration Requirements:**
   - Agents run via Bun scripts with repo access
   - Read permissions: `features/**`, `e2e/fixtures/**`
   - Write permissions: `features/{FEATURE_KEY}/plan.md`, `features/{FEATURE_KEY}/report.md`, `e2e/shepherd/{FEATURE_KEY}/**`
   - Must use existing `playwright.config.ts` (headless browsers, retries, traces)
   - Generated tests must reference their source plan and seed test in comments

5. **Seed Test Pattern:**
   - Each feature gets a `seed.spec.ts` that bootstraps environment (login, navigation, etc.)
   - Seed tests provide ready-to-use `page` context for generated tests
   - Agents use seed tests as examples to establish testing patterns

````gherkin mode=EXCERPT
Feature: Playwright Agents integration
  As a testing workflow owner
  I want Planner, Generator, and Healer wired into our Playwright stack
  So that shepherd suites can be created and maintained automatically

  @REQ-FSH-002
  Scenario: Initialize Playwright Agents
    When I run "npx playwright init-agents --loop=claude"
    Then agent definitions should be created in .github/ directory
    And the agents should be configured to work with our directory structure

  @REQ-FSH-002
  Scenario: Generate test plan and tests for a feature
    Given Playwright Agents are initialized
    And features/auth/ contract files exist (prd.md, acceptance.md, data.md, shepherd.config.json)
    When I invoke the Planner agent for FEATURE_KEY "auth"
    Then it should generate features/auth/plan.md with test scenarios
    When I invoke the Generator agent
    Then it should create e2e/shepherd/auth/seed.spec.ts and scenario tests
    When I invoke the Healer agent
    Then failing tests should be debugged and fixed automatically
````

---

### REQ-FSH-003: Seed E2E Fixtures and Golden-Path Tests for Agents

Provide **seed tests and shared fixtures** so agents have high-quality patterns to copy:

- Under `e2e/fixtures/`:
  - **Auth/storageState** fixture for logging in test users (reusing Clerk test mode).
  - **Base URL** configuration (already in `playwright.config.ts`) is respected.
  - Helpers such as:
    - `gotoFeature(featureKey: string)` – navigates to the main entry point for the feature using `shepherd.config.json`.
    - `assertNoConsoleErrors()` – fails tests on unexpected console errors.
- At least one **golden-path E2E test** for an existing feature (e.g., auth) using these fixtures.
- Agent-generated shepherd tests must **reuse** these fixtures (not create redundant auth/baseURL logic).

**Shared Setup Preference:**

- **Preferred**: One shared `e2e/fixtures/shepherd.ts` that provides `setupFeature(featureKey)` for common bootstrap logic
- **Per-feature seed files** (`e2e/shepherd/{FEATURE_KEY}/seed.spec.ts`) should be **thin wrappers** calling shared setup
- Only create feature-specific seed logic when absolutely required (unique auth flow, special feature flags, etc.)
- This prevents duplication and drift across shepherd suites

````gherkin mode=EXCERPT
Feature: Seed fixtures for shepherds
  As a Playwright Agent
  I want shared helpers for auth and navigation
  So that generated tests follow consistent patterns

  @REQ-FSH-003
  Scenario: Generated tests reuse shared helpers
    Given shared helpers gotoFeature and assertNoConsoleErrors exist
    Then new shepherd tests for "checkout" call those helpers instead of duplicating logic
````

---

### REQ-FSH-004: Shepherd Prompt Template and Planner Output

Define a **single “shepherd prompt”** template and Planner responsibilities:

- Create `features/_templates/shepherd.prompt.md` containing:
  - Goal: “Create and maintain an end-to-end Feature Shepherd suite for {FEATURE_KEY} using Playwright Agents.”
  - Authoritative inputs list:
    - `features/{FEATURE_KEY}/prd.md`
    - `features/{FEATURE_KEY}/acceptance.md`
    - `features/{FEATURE_KEY}/data.md`
    - `features/{FEATURE_KEY}/shepherd.config.json`
    - Existing Playwright fixtures/helpers under `e2e/`.
  - Clear description of Planner, Generator, Healer responsibilities and output files.
- For a given feature key:
  - Planner reads inputs and writes **`features/{FEATURE_KEY}/plan.md`** in Markdown.
  - Plan must include:
    - Happy-path journey.
    - Permission/role checks.
    - Validation of key invariants.
    - Representative negative cases (real failure modes, not contrived).
    - Minimal, non-redundant scenario set.
  - Each scenario in the plan must include preconditions, steps, assertions, and references into `data.md`.

````gherkin mode=EXCERPT
Feature: Shepherd planning prompt
  As a Planner agent
  I want a standard prompt and inputs
  So that I can write consistent plans per feature

  @REQ-FSH-004
  Scenario: Planner generates a plan for checkout
    Given features/checkout has prd.md, acceptance.md, data.md, shepherd.config.json
    When the Planner runs with FEATURE_KEY "checkout"
    Then it writes a test plan to features/checkout/plan.md based on those inputs
````

---

### REQ-FSH-005: Generated Shepherd Test Suites and Reports

Generator and Healer must manage a **dedicated shepherd test suite** per feature and produce a **human-readable report**:

- Generator reads `features/{FEATURE_KEY}/plan.md` and writes Playwright tests under:

  `e2e/shepherd/{FEATURE_KEY}/**`

- Tests must:
  - Use **resilient locators** (roles/text/testid, not fragile CSS selectors).
  - Reuse shared fixtures/helpers from `e2e/fixtures/**`.
  - Include **strong assertions** on UI state and navigation/URL, and optionally network behavior where appropriate.
  - Capture diagnostics (screenshots/traces/logs) via existing Playwright config.
- Healer:
  - Debugs and updates shepherd tests to keep them stable when **UI details change**, but
  - **Must not “heal around” real regressions**; instead, it must surface them as failures.
- After each Planner/Generator/Healer run, Agents write:

  `features/{FEATURE_KEY}/report.md`

  summarizing what was generated/changed, what is covered, and known gaps.

````gherkin mode=EXCERPT
Feature: Shepherd test generation
  As a Generator and Healer
  I want to manage tests under e2e/shepherd/{FEATURE_KEY}
  So that each feature has a focused, maintainable suite

  @REQ-FSH-005
  Scenario: Generate and report shepherd tests
    When the agents run for FEATURE_KEY "checkout"
    Then tests exist under e2e/shepherd/checkout
    And a report exists at features/checkout/report.md describing coverage and gaps
````

---

### REQ-FSH-006: One Shepherd per Feature and CI Wiring

Ensure each feature shepherd suite is **independently runnable** and **CI-connected**:

- Tests must be runnable per feature, e.g.:

  - Running only `e2e/shepherd/checkout/**` via Playwright CLI.
- CI must be able to map changed files → impacted shepherds:
  - If a PR touches `features/{FEATURE_KEY}/**` or `app/{FEATURE_KEY}/**` (or equivalent routes/components for that feature), CI runs only `e2e/shepherd/{FEATURE_KEY}/**`.
  - Nightly/staging workflow runs **all** shepherd suites: `e2e/shepherd/**`.
- CI runs use:
  - Headless browsers, retries, and screenshot/trace capture.
  - Clear reporting of which shepherds ran and which requirements (`@REQ-*` tags) they cover.

````gherkin mode=EXCERPT
Feature: CI wiring for shepherd suites
  As a CI pipeline
  I want to run only impacted shepherds on PRs
  So that feedback is fast and focused

  @REQ-FSH-006
  Scenario: PR touching checkout runs checkout shepherd
    Given a PR changes files under features/checkout or app/checkout
    When CI runs E2E tests
    Then only the e2e/shepherd/checkout suite is required to pass for that job
````

---

### REQ-FSH-007: Foundational Flow Coverage (Auth + Home)

Ensure the first shepherded feature covers critical authentication and home page flows that must work before any other features:

**Required Flows:**
- Home page must render without console errors
- User account creation flow must complete successfully
- Login flow must establish valid session
- Logout flow must clear session
- Re-login flow must work after logout
- Account deletion flow must complete
- Navigation between home and authenticated pages must work

**Data Isolation Requirements:**

To prevent test collisions (especially with account deletion), each shepherd run must use isolated test data:

- **Unique per-run emails** - Use timestamp or UUID in email addresses (e.g., `test-{timestamp}@example.com`)
- **Seeded tenant + reset hook** - Optionally use a dedicated test tenant that is reset before each run
- **Ephemeral test environment** - Preferred: dedicated test environment with database reset between runs
- **Test user lifecycle** - Document in `features/auth/data.md`:
  - How test accounts are created (API, Clerk test mode, seeded DB)
  - How test accounts are cleaned up (account deletion flow, manual cleanup, DB reset)
  - Collision avoidance strategy (unique emails, tenant isolation)

This prevents flaky failures from shared test user contention.

````gherkin mode=EXCERPT
Feature: Authentication and Home Page Shepherds
  As a user
  I want reliable auth flows and error-free navigation
  So that I can access the platform consistently

  @REQ-FSH-007
  Scenario: Home page renders without errors
    Given I navigate to the home page
    Then the page should load successfully
    And there should be no console errors
    And all hero images should render

  @REQ-FSH-007
  Scenario: Complete auth lifecycle
    Given I am on the home page
    When I click "Sign Up" or navigate to account creation
    And I complete the account creation form with valid credentials
    Then I should be logged in successfully
    And I should see the authenticated dashboard or home view

    When I log out
    Then I should return to the unauthenticated home page
    And my session should be cleared

    When I log back in with the same credentials
    Then I should be authenticated
    And I should see my previous account data

  @REQ-FSH-007
  Scenario: Account deletion
    Given I am logged in
    When I navigate to account settings
    And I initiate account deletion
    And I confirm deletion
    Then my account should be deleted
    And I should be logged out
    And I should be redirected to the home page
````

---

### REQ-FSH-008: Feature-to-Code Mapping for Deterministic CI Selection

Define **explicit code-to-feature mappings** in `shepherd.config.json` to enable deterministic CI shepherd selection:

**Required fields in `shepherd.config.json`:**

```json
{
  "featureKey": "checkout",
  "entryUrl": "/checkout",
  "requiredRole": "user",
  "featureFlags": [],
  "codeOwners": {
    "globs": [
      "app/checkout/**",
      "app/routes/checkout/**",
      "src/components/checkout/**",
      "src/lib/checkout/**"
    ],
    "routePrefixes": ["/checkout", "/cart"],
    "labels": ["feature:checkout", "shepherd:checkout"]
  },
  "goldenPath": "...",
  "invariants": []
}
```

**CI Selection Logic:**

CI runs a shepherd if:
- Changed files intersect any `code_owners_globs`, OR
- Any changed file starts with `features/{FEATURE_KEY}/`, OR
- PR has a label matching `labels` array

````gherkin mode=EXCERPT
Feature: Deterministic shepherd selection
  As a CI pipeline
  I want explicit code-to-feature mappings
  So that only relevant shepherds run on PRs

  @REQ-FSH-008
  Scenario: Checkout code change triggers checkout shepherd
    Given shepherd.config.json for "checkout" includes glob "app/checkout/**"
    When a PR changes file "app/checkout/payment-form.tsx"
    Then CI should run e2e/shepherd/checkout/**
    And CI should not run other shepherds (unless they also match)

  @REQ-FSH-008
  Scenario: Feature contract change triggers shepherd
    When a PR changes file "features/checkout/acceptance.md"
    Then CI should run e2e/shepherd/checkout/**
````

---

### REQ-FSH-009: PR vs Nightly Gating Policy

Define **explicit gating rules** for when shepherds block merges vs create issues:

**PR Workflow (Blocking):**
- Run only impacted shepherds (via REQ-FSH-008 mapping)
- Treat shepherd failures as **required checks** (block merge)
- Allow retries (up to 2 retries per test)
- Generate trace/screenshot artifacts for failures

**Nightly/Staging Workflow (Non-Blocking but Alerting):**
- Run **all** shepherds (`e2e/shepherd/**`)
- Failures create GitHub issues with:
  - Feature key
  - Failing scenarios
  - Trace/screenshot links
  - Suspected owner via CODEOWNERS
- Notify via Slack/email (if configured)
- Optionally block deployment if staging must be green (configurable)

````gherkin mode=EXCERPT
Feature: Gating policy for shepherds
  As a release manager
  I want clear rules for when tests block vs alert
  So that PRs move fast but regressions are caught

  @REQ-FSH-009
  Scenario: PR shepherd failure blocks merge
    Given a PR changes "app/checkout/payment-form.tsx"
    When the checkout shepherd fails
    Then the PR status check should be "failed"
    And the PR cannot be merged until fixed

  @REQ-FSH-009
  Scenario: Nightly shepherd failure creates issue
    When nightly run detects auth shepherd failure
    Then a GitHub issue should be created with label "shepherd:auth"
    And the issue should include trace, screenshots, and CODEOWNERS
    And deployment is not blocked (unless configured otherwise)
````

---

### REQ-FSH-010: Healing Policy & Regression Escalation

Define **explicit rules** for what the Healer agent can change vs when it must escalate as a regression:

**Healer MAY Change:**
- Locators (if element still exists with equivalent semantics)
- Wait times / retries (within configured limits, e.g., ≤ 10s)
- Navigation steps that don't change test intent
- Helper function usage (e.g., switching to shared fixtures)

**Healer MUST STOP and File Regression When:**
- Acceptance assertion fails (business invariant not met)
- Required UI element is permanently missing
- API call semantics change (unexpected 4xx/5xx or response shape mismatch)
- New console errors appear that weren't previously allowed
- Test timeout exceeds threshold (> 2 retries)

**Regression Issue Must Contain:**
- Feature key and failing scenario
- Playwright trace zip
- Screenshots at failure point
- Full error message and stack trace
- Suspected owner via CODEOWNERS lookup
- Link to `plan.md` and failing spec
- Labels: `regression`, `shepherd:{FEATURE_KEY}`

````gherkin mode=EXCERPT
Feature: Healing escalation policy
  As a Healer agent
  I want explicit rules for when to heal vs escalate
  So that I don't mask real regressions

  @REQ-FSH-010
  Scenario: Healer fixes locator drift
    Given a button changed from <button class="submit"> to <button class="btn-submit">
    When the Healer inspects the UI
    Then it should update the locator to match the new class
    And the test should pass

  @REQ-FSH-010
  Scenario: Healer escalates missing element
    Given an acceptance test expects a "Checkout" button
    When the button is no longer in the UI
    Then the Healer should stop retrying
    And file a regression issue with trace, screenshots, CODEOWNERS
    And tag with "regression" and "shepherd:checkout"

  @REQ-FSH-010
  Scenario: Healer escalates business logic regression
    Given a test asserts "order total should be $100.00"
    When the UI shows "$95.00" due to a code change
    Then the Healer should not change the assertion
    And file a regression issue flagging the invariant violation
````

---

### REQ-FSH-011: Determinism & Test Generation Controls

Enforce **determinism and version control** for agent-generated tests to prevent drift:

**Version Pinning:**
- Pin Playwright version in `package.json`
- Pin Playwright Agents tooling version
- Regenerate agent definitions only when explicitly updating (not automatically)

**Test Plan Stability:**
- Commit `plan.md` to version control
- Treat `plan.md` diffs like code review (require approval for changes)
- Enforce structured format (Markdown with required sections)
- Run plan diff checks in CI to detect unexpected regeneration

**Regeneration Triggers (Explicit Only):**
- Manual command: `npm run shepherd:regen -- {FEATURE_KEY}`
- PR label: `shepherd:regenerate`
- Feature contract change (acceptance.md, prd.md, shepherd.config.json updated)

**Prevent Implicit Drift:**
- Generated tests include header comments referencing plan.md commit hash
- CI fails if generated test doesn't match its plan
- Require human review for plan changes affecting > 5 test files

````gherkin mode=EXCERPT
Feature: Test generation determinism
  As a repo maintainer
  I want stable, reviewable test plans
  So that agent changes are auditable

  @REQ-FSH-011
  Scenario: Committed plan.md prevents drift
    Given features/checkout/plan.md is committed at hash abc123
    When CI runs the Generator
    Then it should produce tests matching the committed plan
    And fail if generated tests reference a different plan version

  @REQ-FSH-011
  Scenario: Explicit regeneration required for plan changes
    Given I update features/checkout/acceptance.md
    When I run "npm run shepherd:regen -- checkout"
    Then the Planner should generate a new plan.md
    And the diff should be reviewable in the PR
    And I must approve the plan changes before merging
````

---

### REQ-FSH-012: Test Metadata Headers for Traceability

All generated tests must include **machine-readable metadata headers** for reporting and debugging:

**Required Header Format:**

```typescript
/**
 * @featureKey checkout
 * @scenario add-item-to-cart
 * @requirements REQ-FSH-001, REQ-CHECKOUT-003
 * @planSource features/checkout/plan.md@abc123
 * @seedTest e2e/shepherd/checkout/seed.spec.ts
 * @generatedAt 2025-12-13T10:30:00Z
 * @lastHealed 2025-12-13T12:45:00Z
 */
```

**Usage:**
- CI reporting can aggregate coverage by `@requirements`
- Failed tests link to `@planSource` for context
- `@lastHealed` timestamp tracks when Healer last modified the test
- `@featureKey` enables filtering and issue tagging

````gherkin mode=EXCERPT
Feature: Test metadata for traceability
  As a test reporter
  I want structured metadata in every generated test
  So that I can aggregate coverage and trace failures

  @REQ-FSH-012
  Scenario: Generated test includes required headers
    When the Generator creates e2e/shepherd/checkout/add-item.spec.ts
    Then the file should include a metadata header
    And the header should contain @featureKey, @scenario, @requirements
    And @planSource should reference the commit hash of plan.md

  @REQ-FSH-012
  Scenario: CI report aggregates by requirements
    Given tests include @requirements tags
    When CI runs shepherd suites
    Then the report should show which REQ-* IDs are covered
    And which tests cover each requirement
````

---

## Technical Feasibility

**Research Required:**

- [ ] Confirm compatibility of **Playwright Agents** with:
  - Bun-based workflows and our current Node/Playwright versions.
  - The existing `playwright.config.ts` and `e2e/` structure from `tasks/testing/setup-playwright.md`.
- [ ] Validate the Agents’ ability to:
  - Restrict read/write operations to `features/**` and `e2e/shepherd/**`.
  - Respect our repo’s TypeScript, linting (Biome), and formatting rules.
- [ ] Ensure CI runners can:
  - Install and cache Playwright browsers and any additional dependencies needed by Agents.
  - Run agents and Playwright in parallel without timing or port conflicts.

**CI Parallelization & Resource Management:**

- **Worker Count Constraints:**
  - Limit Playwright workers per job (e.g., `workers: 2` for CI to avoid resource contention)
  - For multiple shepherds on the same runner, use GitHub Actions matrix strategy to run one feature per job
  - Example: `matrix: { feature: [auth, checkout, dashboard] }` → 3 parallel jobs

- **Artifact Retention:**
  - Retain trace zips, screenshots, and videos for **7 days** (GitHub Actions default)
  - Naming convention: `shepherd-traces-{FEATURE_KEY}-{RUN_ID}.zip`
  - Upload artifacts only on failure (to save storage)
  - Attach artifacts to regression issues (via GitHub API or workflow action)

- **Port Collision Avoidance:**
  - Use `PORT=0` or randomized ports for local dev servers if tests start one
  - Prefer targeting deployed preview/staging URLs over local servers in CI

- **Browser Installation:**
  - Cache Playwright browsers via GitHub Actions cache or pre-installed runner images
  - Pin Playwright version in `package.json` to ensure cache hits

**Constraints:**

- Must **reuse the existing Playwright configuration** and scripts (no alternative test runners).
- All new code must be **TypeScript** and conform to Biome linting.
- No long-lived, stateful runner assumptions: each CI job is ephemeral.
- Agent behavior must be **deterministic enough** for CI (REQ-FSH-011 enforces version pinning and plan stability).

---

## Dependencies

**Internal Dependencies:**

- `documentation/PRDs/workflow.md` – overall workflow & testing strategy.
- `documentation/PRDs/product.md` – canonical feature definitions and requirements.
- `tasks/testing/setup-vitest` – unit test infrastructure (to test agent-wiring code).
- `tasks/testing/setup-playwright` – base Playwright E2E configuration.
- `tasks/workflow/task-generation` – PRD → task generation (for this PRD itself).

**External Dependencies:**

- Playwright + Playwright Agents libraries and their CLIs.
- CI runners with support for Playwright browsers (e.g., GitHub Actions images).
- Access to test/staging environments with stable URLs and seeded data.

---

## Security & Secrets Management

**Secrets Required for Shepherd Tests:**

- **Clerk Test Mode Keys** - For auth flows (account creation, login)
- **Staging/Preview Environment URLs** - Where shepherds run (not production)
- **Test User Credentials** - Seeded accounts or dynamically created
- **Feature Flag Toggles** - If tests need to enable/disable features

**CI Secrets Policy:**

1. **Environment Protection:**
   - Secrets only available to trusted branches (`main`, `staging`, release branches)
   - Forked PRs **do not** get access to secrets (GitHub's default behavior)
   - Use GitHub Environment protection rules to require manual approval for external contributors

2. **Agent Write Restrictions:**
   - Agents can only write to `features/**` and `e2e/shepherd/**` (enforced via workflow permissions)
   - No write access to `.github/workflows/**`, `src/**`, or sensitive config files
   - Post-run verification step: `git diff --exit-code` on non-allowed paths (fails if agents wrote outside bounds)

3. **Artifact Security:**
   - Traces/screenshots may contain sensitive data (user emails, session tokens)
   - Limit artifact access to repository collaborators only (GitHub default)
   - Auto-delete artifacts after 7 days
   - Redact sensitive values in logs (use Playwright's `maskText` for PII)

**Example CI Workflow Snippet:**

```yaml
jobs:
  shepherd:
    environment: staging  # Requires approval for external contributors
    permissions:
      contents: read      # Read repo
      issues: write       # File regression issues
      actions: read       # Read workflow runs
    steps:
      - name: Run Shepherd Tests
        env:
          CLERK_TEST_KEY: ${{ secrets.CLERK_TEST_KEY }}
          STAGING_URL: ${{ secrets.STAGING_URL }}
        run: npx playwright test e2e/shepherd/auth

      - name: Verify Agent Write Bounds
        run: |
          # Fail if agents wrote outside allowed paths
          git diff --exit-code -- ':!features' ':!e2e/shepherd'
```

---

## Test Strategy

**Unit Tests:**

- For any glue code that:
  - Maps `{FEATURE_KEY}` to `features/{FEATURE_KEY}/` and `e2e/shepherd/{FEATURE_KEY}/`.
  - Parses `shepherd.config.json` and resolves entry URLs/roles/flags.
- For helper utilities (`gotoFeature`, `assertNoConsoleErrors`) where logic can be isolated.

**Integration Tests:**

- Validate that invoking the Agents (Planner/Generator/Healer) on a **test feature**:
  - Produces `plan.md`, `report.md`, and an initial `e2e/shepherd/{FEATURE_KEY}` suite.
  - Does not write outside the allowed directories.
- Test the CI selection logic:
  - Given a set of changed file paths, ensure only the expected shepherds are selected.

**E2E Tests:**

- Use an initial seed shepherd (e.g., checkout) as a **meta-E2E**:
  - Ensure that running the shepherd suite passes on dev and staging.
  - Ensure that regenerating tests (after benign UI changes) keeps the suite green.
- For critical flows (auth + checkout):
  - Require at least one shepherd suite before marking this PRD as **Complete**.

---

## Rollback Plan

**Revert Strategy:**

- Keep existing E2E tests **independent** of shepherd suites:
  - If shepherds become flaky or Agents misbehave, we can temporarily:
    - Disable the agent invocation steps in CI.
    - Skip the `e2e/shepherd/**` jobs, while keeping other tests and deployments intact.
- Feature folders (`features/{FEATURE_KEY}/`) are additive documentation; they can remain even if shepherd automation is temporarily disabled.

**Database Rollback:**

- No schema changes are required by this PRD.
- Any future schema introduced solely for shepherd telemetry (if any) must:
  - Be optional and non-critical to application runtime.
  - Have migrations with standard rollback steps, documented separately.

**Monitoring:**

- Track:
  - Shepherd suite pass/fail rates per feature over time.
  - Flakiness (retries/instability) for shepherd tests.
  - CI duration impact when shepherd suites are enabled.
- Introduce alerts or dashboards (textual/log-based initially) if:
  - A feature’s shepherd suite is consistently red.
  - A meaningful increase in CI runtime occurs after enabling shepherds.

---

## Task Breakdown

(Tasks are indicative; `/prepare-prd` will generate concrete task files under `tasks/testing/`.)

1. **testing/feature-shepherd-contracts** – Define and implement the `features/{FEATURE_KEY}/` contract structure (prd/acceptance/data/risks/config/plan/report).
2. **testing/playwright-agents-bootstrap** – Integrate Playwright Agents with the existing `e2e/` setup and configure Planner/Generator/Healer.
3. **testing/feature-shepherd-seed-fixtures** – Create shared E2E fixtures (`gotoFeature`, `assertNoConsoleErrors`, auth/storageState) and golden-path tests used by agents.
4. **testing/feature-shepherd-prompt-template** – Add `features/_templates/shepherd.prompt.md` and validate it end-to-end with the auth pilot feature.
5. **testing/feature-shepherd-ci-wiring** – Implement CI logic that maps changed files to `e2e/shepherd/{FEATURE_KEY}` suites and adds nightly/staging full runs (REQ-FSH-008, REQ-FSH-009).
6. **testing/feature-shepherd-pilot-auth** – Onboard the `auth` feature as the first shepherded feature, covering home page rendering, account creation, login, logout, re-login, and account deletion flows (REQ-FSH-007).
7. **testing/feature-shepherd-healing-policy** – Implement Healer escalation rules, regression issue creation with required artifacts (trace, screenshots, CODEOWNERS) (REQ-FSH-010).
8. **testing/feature-shepherd-determinism** – Pin versions, commit plan.md to version control, implement plan diff checks, and explicit regeneration triggers (REQ-FSH-011).
9. **testing/feature-shepherd-metadata** – Add metadata header generation to Generator agent, implement CI reporting by @requirements tags (REQ-FSH-012).
10. **testing/feature-shepherd-data-isolation** – Implement unique per-run emails or seeded tenant reset for auth tests, document test user lifecycle (REQ-FSH-007).
11. **testing/feature-shepherd-security** – Configure GitHub Environment protection, agent write restrictions, artifact security, and CI secrets management (Security section).

---

## Success Metrics

| Metric                                      | Target                                      |
|--------------------------------------------|---------------------------------------------|
| Time to onboard a new feature shepherd     | ≤ 30 minutes after feature contract exists |
| PRs touching a shepherded feature that run its shepherd suite | ≥ 95%                          |
| Shepherd test flakiness (retries/failures without code change) | < 2% of runs                 |
| Foundational flows (auth + home) covered before other features | 100% before adding checkout/payments |
| Detection of regressions via shepherds before production | ≥ 90% of regressions in covered flows |
| **Auth UI functionality** | Login, logout, account creation/deletion working smoothly in UI with zero console errors |
| **Test plan regeneration capability** | Deleting `plan.md` and regenerating via Planner produces passing tests (validates agent robustness) |

---

## References

- `documentation/prd-template.md` – Base structure for this PRD.
- `documentation/PRDs/workflow.md` – Overall workflow, testing, and automation strategy.
- `tasks/testing/setup-playwright.md` – Existing Playwright E2E setup.
- Playwright documentation – https://playwright.dev/docs/intro
- **Playwright Agents documentation (source of truth)** – https://playwright.dev/docs/test-agents
